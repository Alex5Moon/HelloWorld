### 不要把自己当学生，以为我写的公众号文章是传授知识，我只是为了好玩讲讲IT发生的故事。也不要把我当老师，“毁人不倦”会给我造成莫名的压力的
在节目开始之前，我先来回答一个ID叫超级炮车（还有个ID叫家住海边喜欢浪的朋友，说真的，真希望大家每个人都注册一个公众号写文章，能碰到好多有趣的人和事儿，目前这两个ID是我最喜欢的两个）的读者的问题，其实不算是回答，昨天我发出那篇在裸机上运行软件的文章以后，有个热心的读者和我共同讨论操作系统的问题。后来还加了微信，讨论了好久，说实在的，我虽然35岁了，而这位读者只有18岁刚上大学，他对操作系统的理解很多地方远超过我。让我很佩服很欣慰。我这内心还是一个技术宅男，相比于技术，我其实挺不喜欢讨论经济啊，政治啊，金融这种话题的，那都是上层阶级关心的问题，我更喜欢没事折腾一下电脑，和两个孩子玩玩。

我们讨论的问题其实也很简单，就是如何编译一个软件，让这个软件可以不借助于操作系统运行。

比如说，我们从网上下载了一个游戏，比如魔兽争霸这个游戏吧，如果没有操作系统，我们是没法让这个系统运行起来的。因为你要把这个软件装在操作系统上，游戏才能运行。

如果一段代码可以直接运行在硬件上，而这一段代码恰好可以做“管理计算机的硬件资源”这件事儿，那这段代码就是一个操作系统。如果这段代码不做“管理计算机硬件资源”的事儿，就是一个不依赖操作系统的代码。

如何才能做到呢？重点就是静态链接所有的依赖，并且规定这个程序内存地址空间的顺序。因为现在我们都是用IDE集成开发环境来开发软件，所以，很多同学认为编译和链接是一个过程，其实，是两个独立的过程，编译是编译，链接是链接，现在的编译器基本上都有以下的功能，一个是可以指定特定的函数在生成的文件中的偏移量，还有一个功能是保存一张符号表，说明里面每一个函数的偏移量。知道了这些东西，让loader直接根据规定的偏移量，直接调用entry function就行了。比如说，如果有年纪比较大的朋友，用过MS－DOS的，我就用过MS－DOS，其实DOS的本质就是一个loader。

好了，开始讲故事了，上一期说了，林纳斯自己在软盘里写了一个可以启动的终端模拟器，用来上网，在网上发帖，看新闻。这个软件的功能也就是这些，没有其它的功能了，但是林纳斯希望能再添加一点功能，他想从网上下载或者上传一些文件，但是目前的终端仿真器没法完成这个任务。因为，这个软盘如果想能存储文件的话，需要有一个文件系统。

我们都应该知道文件系统吧，比如我们知道windows上用的文件格式是NTFS格式，Linux的格式是ext4格式，等等。因为linus的年代使用的是软驱，说实在的，我用软驱的机会也不多，用过，但是不多。我用电脑的时候，软驱就接近退役了。

因为我对软驱和软盘了解不多，也不可能再为了写这篇文章去研究一个已经退役了的技术，但是，我可以谈硬盘，我还是了解一些机械硬盘的，假设林纳斯想在机械硬盘上弄一个文件系统，他应该关注哪些技术细节呢？

硬盘在操作系统里，和其他的硬件设备，比如键盘控制器一样，是通过对硬盘控制器的I/O接口来操作的。硬盘的I/O端口分为两种，一种是命令块寄存器，一种叫控制块寄存器。简单来说，先向命令块寄存器中写入正确的值，再通过控制块寄存器发送命令，就可以了。

我们买回某个硬件，有时候需要装驱动程序，其实硬盘也有驱动程序，只是，操作系统帮我们装好了，我们不知道而已，他偷偷帮我们装好了。驱动程序的作用就是隐藏硬件的细节，向其它的使用他的进程提供统一的接口。由于林纳斯完全自己写文件系统，所以，他要自己写一个文件系统驱动，来查看磁盘的组织结构。按照他自传里说的，他要把文件保存在Minix系统上，所以，这个文件驱动需要兼容Minix系统。

在自传里他并没有透露他的硬盘容量的大小，我也很难查到其他的资料。但是，那个年代的硬盘是一种叫IDE的接口，这个标准是西部数据，康柏，希捷这些公司合作开发的一种标准接口，还没有现在我们使用的SATA接口。为了区别，林纳斯那个年代的接口我们称之为“并口硬盘”，现在的硬盘，我们称之为“串口硬盘”。他们的祖宗都是1973年IBM开发的一种叫“温彻斯特硬盘”的东西。所以，在很多地方，现在仍然可以看到Winchester这个驱动文件，不用想，99%是硬盘驱动。

大体讲了一下硬盘，有了硬盘以后，再说说文件系统了，比如FAT32， NTFS这种的，就是文件系统。当年林纳斯需要兼容Minix的文件系统。我在维基百科上看了一下Minix的文件系统，这是一种学习Unix文件系统的东西。当然我也不懂，我就以FAT32的格式来代替吧，我觉得本质差别不大。

先说大概的，要弄一个文件系统，从大的考虑要搞定这几件事情：

有地方记录硬盘上扇区使用的情况
有地方记录哪个文件占用了哪些扇区
有地方存放文件的索引

总结成一句话来说：就是用于存储，组织和管理计算机文件数据的一套方法。

为了开发这个文件系统，我们可爱的林纳斯同学，放弃了社交活动，生活只剩下了吃饭，编程，睡觉，吃饭，睡觉，编程，花了好几个月的时间，在自传里他说，整个夏天，他除了编程，什么也没干！终于搞定了文件系统和shell。期间沮丧过很多次。我从他的自传里挑出一些故事来，讲一讲林纳斯的激情燃烧的岁月，以表达我对林纳斯无限的敬佩。

这个项目花了我很大的力气，我的日程也安排成了编程——睡觉——编程——睡觉——编程——吃饭（椒盐卷饼）——编程——睡觉——编程——洗澡（随便冲冲了事）——编程。随着项目的逐渐完善，我意识到它越来越像一个操作系统了。于是我改变了想法，不再把它当成一个改进型的终端仿真程序，而是一个可运行的操作系统。既然他的功能已如此之多，那么只需再加把劲，它就能破茧成蝶，变成一个操作系统了。

每当我看到这一段的时候，我就很感慨，纯粹是兴趣，造出来了一个操作系统。对喜欢编程的人来说，编程是世界上最有趣的事情，对不喜欢编程的人来说，编程是世界上最无趣的事情。

编程还是要分为两种，一种是兴趣编程，一种是谁给的钱多，我就给他编程。这两种有时候是冲突的，尤其是后者，其实并没有啥乐趣的。我干过很多这种的，其实和农民工挖水沟区别也不大，客户就让你这么干，你自己是不能发挥的，比如我年轻曾经给一个医院做过一个项目，自动结账的系统，当时觉得很先进，就是你医院的员工要发工资，或者报销的时候，用这个系统，可以提高效率。结果，我们都弄成全自动的了，然后医院的领导说不行，我们问为啥不行？ 他说，你这都全自动了，财务上的人怎么办？最后我们只好修改了系统，每次报账或者发工资，财务上得四个人，分别点四次确定，然后还得在个对话框里输上自己的名字，并且有个摄像头拍一张点确定的这个人的照片，然后这个钱才能发下去。有时候啊，这个生活… 很无奈，我也是啊，为了混口饭吃，人家让怎么改就怎么改...

可能是因为我在现实中经常被客户蹂躏，所以，我才热衷于技术，也许有点躲避现实的感觉吧，我也不知道啊，我真心觉得编程很有意思。有时候，调试bug的时候，尤其是调试了半天，突然找到了bug，那种感觉真是太爽了！我也很热衷于学习新东西，各种有用的没用的编程知识，编程故事知道了一大堆,所以，我就写个公众号告诉后来者，如果有人喜欢听的话，我也很欣慰。

最后，我学习了好几天怎么录屏，以前的几期录的太差了，废话也太多。我有一个为期5年的录视频计划，把我知道的编程知识，都录成视频，放在三个地方吧，百度网盘这个可以下载，B站，B站的好处是没有广告，和腾讯视频里。之所以放腾讯视频，是因为微信公众号里要添加视频链接，只能放腾讯视频，而且还可能有广告。百度网盘的链接我就放在公众号里，随时往里面添加我录好的视频。这期就到这里，再见。

百度网盘链接:  https://pan.baidu.com/s/1pKDT10J

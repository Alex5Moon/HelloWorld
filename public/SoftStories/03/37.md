### 做个操作系统吧 ?
林纳斯在中学毕业以后，就去了赫尔辛基大学，上两期我在说到芬兰的教育的时候，有好心的朋友提醒我，芬兰的大学包括赫尔辛基大学在内的一些学校，已经开始准备对非欧盟的学生收取学费了，免费的午餐对中国学生可能要结束了。

就在读大学期间，林纳斯做出了linux操作系统，做一个操作系统需要什么呢？第一需要一台电脑，第二需要足够的时间。这两点，林纳斯都具备。第一，他花了3000多美元买了一台电脑；第二，他在赫尔辛基大学呆了8年，反正在芬兰，读大学是免费的。我们来仔细的说说这两点。当然，肯定不止这两点，还有第三点第四点第五点，比如林纳斯聪明啊，有耐心啊，但是这些说起来没啥意思。就只说两点。

在进入话题之前，先说点题外话。我这个故事，都是来自林纳斯的自传《只是为了好玩》，如果大家喜欢看故事的话，买本书回来看，肯定远比我在这里叨逼叨逼的说要强很多。所以，非常建议大家购买这本书，名字叫做《只是为了好玩》。上一期文章我也说了，我讲这个故事的目的是借linux操作系统，试图还原一下历史场景，通过这个故事，来深入的谈编程语言和操作系统的进化。也就是我的“一家之言”，通过linux这个故事，夹带私货讲编程语言和操作系统的历史。如果有人只是对林纳斯这个人感兴趣，对操作系统和编程语言都不感兴趣，那就买书吧，我这里故事讲的很简略，对操作系统和编程语言以及硬件，讲的比较多。

我们先来谈一个问题，截止到今天，2016年8月13日，Linux的稳定版的kernel是4.7版，大家猜有多少行代码？我就先公布答案，是1700万行代码。在Linux发布1.0版本的时候，代码行数是15万行左右。如果大家对1700万行没啥概念的话，我们都知道《红楼梦》这本书吧。总共有60万字左右，也就是说，每个《红楼梦》上的字，对应于30行代码。把字印的小一点的话，30行代码可以挤在一页A4纸上，如果要把Linux4.7版本的核心代码全部打印出来的话，大概需要25万张打印纸，也就是500包打印纸那么多，搞不好五菱之光的面包车，一车还拉不了。

所以说，对绝大部分人，当然包括我来说，这么多的代码，公开了和不公开其实没啥区别，反正也看不懂。这打印在纸上一面包车都拉不完的代码，积累了前辈几十年的经验，和一系列的理论成果，让智商一般的人，根本就是老虎吃天，无从下口啊。所以，我这个公众号，试图从林纳斯最初的买回电脑来的时候，慢慢的分析过来，主要是满足我的好奇心。这些工作我好多年前就做了，在我读大学的时候，读过一本书叫做《Linux Core Kernel Commentary》, 这本书我断断续续的读了好多年，从本科一直陪伴到我工作，一直没舍得丢的书之一，有一点小心得，希望能在以后的故事里，借助林纳斯发明Linux操作系统的故事，把操作系统是如何运行起来的给讲清楚。

大家可能会说，我课堂上学过操作系统啊，感觉不难。其实，这句话真的错了。如果没有接触过操作系统的代码，就算看好几本教科书，也没啥大用。为什么这么说呢？教科书讲的内容，省略了操作的细节，实际情况，当你看Linux源代码的时候，不停的卡住，那些教科书上省略掉的部分，直接能让我们怀疑人生。我以后的故事，主要是参考《Linux Core Kernel Commentary》这本书以及林纳斯的自传《只是为了好玩》，更多的参考资料也就不一一列出了，更多的东西，可能是上学时候为了考试，过了好多年没忘掉的部分。另外我的工作，有很大部分是基于FreeBSD的代码，增加或者删除一些功能，让这些代码能跑在某种硬件上，也算是和开发操作系统有一点关系吧。

让我们先来看看当年林纳斯在大学里买了一台什么样的电脑。在高中的时候，林纳斯有一台用了三年的电脑，名字叫Sinclair QL，他这台电脑使用的是32位的CPU，运行的频率是8M，内存是128k，现在128k只能存一张分辨率不高的照片，操作系统叫QDOS，这个QDOS和微软买的那个QDOS只是名字一样。

当时，这个QDOS比微软买的那个QDOS要先进一些，支持多任务处理程序。但是，这个操作系统是只读的，不能改写这个操作系统，也就是说当年没有病毒，即使有电脑病毒，也没法感染一个只读的操作系统。所以，在这台机器上，是没发开发操作系统的，因为操作系统只读，没法替换。但是林纳斯还是通过这台电脑，学会了很多东西，比如他在自传中说他给这台电脑的软盘驱动器写了个驱动程序，因为电脑自己的驱动程序有bug，而且他还精通了汇编语言和反编译程序。

通过这些信息，我们可以总结一下。林纳斯高中的时候，一部分电脑已经开始进入32位了，各种各样的电脑都有，并不是只有IBM的PC。操作系统更是五花八门，还没有一个操作系统能像今天一样，占有绝对的优势。有点像《史记》中所说的“秦失其鹿，天下共逐之”的感觉，群雄并起，逐鹿中原，越这种时候，越容易出奇迹。等到市场都稳定了，再想出成绩就难多了！如果时候不合适，一代枭雄朱元璋这种的，也只能去种田去养猪。

林纳斯的这台Sinclair电脑一直陪着他，刚开始的时候，他还是很讨厌IBM的个人电脑的，但是，后来，随着Intel不停的进取，尤其是386出现以后，PC的魅力也就出来了。（在这里宣传一下，我这个公众号——软件那些事儿里——在前几期里有一期的名字叫“指令集之争”，就是讲Intel的故事，希望大家去网易云音乐听听，我个人觉得很有趣，但是大部分人觉得很无趣）那个时候，林纳斯手头很紧，就一直想买一台有386处理器的电脑，然后在上面装上一个Unix来玩玩。

因为在大二的那个假期，林纳斯已经把一本719页的《操作系统：设计与实现》读了好几遍，他早就迫不及待的想学习传闻已久的Unix操作系统了，（在这里还得宣传一下我的微信公众号——软件那些事儿——我在这个公众号里连续做了5期Unix操作系统的故事，当然，不出意外的，阅读量和收听量逐渐下滑，我就赶紧收尾了 :）

林纳斯在他的自传里说，他最迫不及待的一门课叫《C语言与Unix》，当年的林纳斯也是Unix新手，但是他一碰Unix就爱上他了，而且，至今都没有改变，越来越爱了！我再重复一下前5期Unix的故事里我讲的内容，Unix为啥好呢？Unix有进程和管道的概念，后来他创造的Linux完全支持进程和管道的概念。而且Unix设计的非常的简单，完全由6个叫系统调用的操作来构建整个操作系统。因为这六个系统调用非常的重要，我就再重复一下这六个概念，因为毕竟听过我那5期Unix故事的人非常少，第一个叫创建子进程，第二个叫执行，就是刚创建的那个进程执行另一个进程。另外还有四个文件操作，分布是打开，关闭，读取和写入。就这六个操作，构成了Unix的主体结构。

如果再仔细讲，可能还有很多的系统调用，比如Unix的第一个版本，就有23个系统调用，但是，我们这个不展开了。抓大放小，抓住最主要的六个系统调用，就能明白Unix或者Linux。如果在Unix和Linux中创建更复杂的任务，不需要更复杂的接口，只需要配合进程，以及管道，就能创建复杂的任务。（关于“管道”这个概念，还有系统调用的概念，在我做的那5期Unix的故事中已经比较详细的介绍了，在这里不说了，否则时间根本不够用）

林纳斯还在继续攒钱买386的电脑，终于在他21岁的时候，凑够了1000来美元，而当时买一台386的电脑需要3500美元，幸好那家店里可以分期付款，因此他就先付了1/3的钱，赊账的2/3三年内还清就行了。

当时林纳斯就选了一台白色的兼容机，CPU是33MHz的，内存选的4M。选好配置以后，店主说三天以后可以去取货。林纳斯说，那三天就像一个星期那么漫长。等到第三天一到，他就喊上他爸爸，开车去把那台大家伙取回来。大家还记得他老爸吧？那个狂热的共产主义者，去苏联学习如何做一名合格的共产党，家里挂着镰刀斧头的党旗，画面感还挺不和谐的。

这台电脑附送了一个微软的DOS操作系统，但是林纳斯已经订购了另外一个操作系统Minix，后来他和Minix操作系统的作者在网上大吵了一架，以后再说这个故事。这个169美元的操作系统不但很贵，而且，要一个月才能从国外寄过去，买这个操作系统，也算海淘吧，搞得林纳斯非常不爽，首先价格很贵，169美元，其次快递很慢，要30天。这漫长的30天里，林纳斯就在DOS下玩波斯王子这个游戏，要不就是在看看哪本《操作系统》的书。

终于在一个周五的下午，Minix操作系统到货了，整整16张软盘，装上Minix，玩了一段时间以后，他觉得这个系统玩的很不爽，不如学校里的Unix玩的过瘾，他就想写一个终端仿真程序，也就是我们现在常用的terminal或者windows下常用的putty，能ssh，或者telnet的一个程序。他想用这个终端仿真程序，远程连到学校的Unix上，用学校的Unix机器。

而且林纳斯想直接不借助操作系统，直接写一个终端仿真程序，在硬件上直接启动这台电脑。如果有朋友看到这里还没有退出的话，请大家考虑一个问题，给了你一些硬件，没有操作系统，你如何把电脑启动起来呢？在这个微信公众号——软件那些事儿——里，我做过一期节目叫《电脑开机开了啥？》里面详细介绍了电脑启动的流程。如果有好奇宝宝，可以找找那个文章看看。

在下一期里，我想讲一下，如何让一台电脑，连操作系统都没有的情况下，亲手做一个系统，让电脑运行起来。有同学可能会问，为啥讲林纳斯的故事，讲成了编程。我不是说了么，我这个是借助林纳斯的故事，抒发自己的一家之言，可以考虑我们一起玩一个RPG游戏，就是角色扮演游戏。我们现在就扮演那个21岁的林纳斯，所掌握的知识有，高中三年玩了Sinclair的电脑，熟练的掌握了汇编语言，现在贷款买了一台电脑，386的处理器，主频速度是33MHz，内存有4M，电脑还有个软驱。作为林纳斯的我们，已经受够了电脑自带的DOS操作系统，也受够了花了169美元买回来的Minix系统。想写一个从软驱直接启动电脑的软件，用来连上学校的Unix，我们应该怎么做？

下一篇文章，我将会和大家一起研究如何让一台裸机，能运行起来，可能我讲的和当年21岁林纳斯写的不一样，但是，他当年肯定也要用到类似的代码，因为，从BIOS中启动电脑，没啥技巧，也没啥机密，都得这么写，不管是Linux还是微软，都得遵从BIOS的规定。如果有人对电脑启动的过程有疑问，可以在公众号——软件那些事儿——里翻翻以前我做的一期，名字叫《钻钻牛角尖：电脑启动都是启动了啥？》

(其实让一台电脑启动起来，比如说只在屏幕上打印Hello world，真的很简单啊！)

因为下次要讲操作系统的一些原理，希望阅读量下降个5%－10%就好，另外，大家真的不用对技术原理感到难堪，我觉得最后这个林纳斯角色扮演游戏，最终也就是讲讲到Unix最基础的六个系统调用为止。我读书的时候实现过一个玩具类的操作系统，根本不需要多少代码就可以实现一个玩具操作系统。

希望能有人陪我把扮演林纳斯的这个RPG游戏玩下去，根据林纳斯的自传，我们一边看他做了什么事情，一边试图还原他开发一个操作系统的过程。当年我读书的时候，折腾了不少关于操作系统的东西。现在我在FreeBSD系统上工作了好多年了，自己的工作算是和操作系统开发有不少关系，只是我参与开发的操作系统是运行在路由器上的，但也算是操作系统，就是没有桌面环境，我觉得应该能讲清楚这本自传里的技术原理，参考的书是上面说的那本《Linux Core Kernel Commentary》

另外，有两个好奇宝宝公众号里问我收到多少赞赏钱了，截止8月13日晚上21点15分，总共收到了62.2元钱，这个公众号里，我总共写了36篇文章，平均每篇的收入是1块7毛3。今天是收入最多的一天，13块钱，分别是藏马，范没有雄心和Exd这三位朋友赞赏的。非常感谢你们，不管是捧人场的还是捧钱场的 :)

希望大家能给我一点反馈，我真希望微信公众号的文章不止有赞，还有踩，我就能知道我的文章到底几个人赞，几个人踩了，这样我也能把握难易程度。欢迎大家留言，这次到这里，下次再见！
